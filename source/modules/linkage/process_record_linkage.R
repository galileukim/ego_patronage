# input: record links generated by create_record_linkage.R
# output: unified record links into a single database
# intention: create crosswalk between cpf and electoral title
# to identify what is the electoral title of all employees
source(
    here::here("source/modules/setup_preprocess.R")
)

debug <- TRUE
between <- data.table::between
sample_size <- Inf

# ---------------------------------------------------------------------------- #
message("read in data.")

rais_hash_file <- here("data/clean/id/rais_filiado_crosswalk.csv") 

if (isTRUE(debug)) {
    rais_hash_file <- str_replace(rais_hash_file, ".csv$", "_sample.csv")
}

rais_hash <- fread(rais_hash_file)

message("count unique entries for electoral title and cpf by name")
rais_hash <- rais_hash %>%
    setkey(name)

# note that all names by state-year are unique, denoting that these are
# different individuals with the same name, since I performed block merge
rais_hash_clean <- rais_hash[
    !names_with_multiple_cpfs,
    .(name, cpf, electoral_title),
    on = "name"
]

rais_hash_clean_unique <- unique(rais_hash_clean, by = "name")

rais_hash_file %>%
    fwrite(
        here("data/clean/id/rais_filiado_crosswalk_clean.csv")
    )