# input: clean rais_crosswalk generated by process_record_linkage.R
# output: rais crosswalk to partisanship data
# intention: create crosswalk between id_employee and electoral title
# to identify what is the electoral title of all employees
source(
    here::here("source/modules/setup_preprocess.R")
)

library(haven)
debug <- FALSE
sample_size <- ifelse(isTRUE(debug), 1e5, Inf)
between <- data.table::between

# extract all id_employees and merge with cpf to generate crosswalk
rais_id_employee <- read_dta(
    "/home/BRDATA/RAIS/id/RAIS_employee_identifiers.dta",
    n_max = 1e5
) %>%
    select(id_employee, cpf)

rais_hash_table <- fread(
    here("data/clean/id/rais_filiado_crosswalk_clean.csv")
)

rais_hash_table_with_ids <- rais_hash_table[
    rais_id_employee,
    on = "cpf"
]

rais_hash_table_with_ids <- rais_hash_table_with_ids %>%
    setkey(id_employee)

message("check if there are duplicated titles per id_employee")
rais_multiple_titles <- rais_hash_table_with_ids[
    ,
    .(count_titles = uniqueN(electoral_title)),
    by = id_employee
]

number_of_duplicated_titles <- nrow(
    rais_multiple_titles[count_titles > 1]
)

rais_hash_table_with_ids %>%
    select(
        id_employee,
        electoral_title
    ) %>%
    fwrite(
        here("rais_to_filiado_hash_table.csv")
    )